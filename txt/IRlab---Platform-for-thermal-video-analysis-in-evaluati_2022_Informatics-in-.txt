Informatics in Medicine Unlocked 30  2022  100940 Available online 7 April 2022 2352 9148   2022 The Author s . Published by Elsevier Ltd. This is an open access article under the CC BY license   http   creativecommons.org licenses by 4.0   .IRlab   Platform for thermal video analysis in evaluation of peripheral  thermal behavior and blood perfusion  Tomppa Pakarinena    Niku Oksalaa b  Antti Vehkaojaa  aFaculty of Medicine and Health Technology  Tampere University  Tampere  Finland  bVascular Surgery and Procedural Radiology  Tampere University Hospital  Tampere  Finland    ARTICLE INFO   Keywords   Thermal imaging  Angiosome  Peripheral blood flow  Perfusion  Matlab ABSTRACT   Background and objectives  Dynamic thermal imaging in medicine has several advantages in comparison to static  thermal image analysis and has potential as a novel patient assessment method e.g. in the area of vascular  surgery. Since dynamic thermal imaging has become in the scope of research only during the last decade  the  computational available analysis methods are often lacking or not existing. Most of the published software is not  available to the research community or are behind a paywall. IRlab provides an easy to use dynamic thermal  video processing and analysis platform  freely accessible to researchers.  Methods  IRlab is programmed in Matlab R2020b. Computational tools for dynamic analysis are divided into  spatio temporal and spectral methods  where spatio temporal methods consist of region of interest delineation  tools  thermal modulation analysis  standard thermal measures such as median  maximum  minimum and de  viation values  and subtraction and gamma maps. Spectral methods include spectral band power  spectral flow   and wavelet analysis tools. Preliminary data of a single healthy subject was analyzed with the program as a  sample run.  Results  IRlab provides a platform for lower limb thermal image and video analysis with a clear workflow and  variety of processing and analysis tools for time and frequency space analysis. The whole source code for IRlab is  freely available for the research community under the General public license.  Conclusions  IRlab is a versatile tool for dynamic thermal image and video processing. Freeware and open source  programs for medical thermal imaging are severely lacking  thus as a completely open source project IRlab offers  a unique platform for researchers within the field of medical thermal imaging.    1.Introduction  Human body produces heat mainly through metabolic processes and  muscle contraction  and the heat is transferred from the heart around the  body through blood flow  1 2 . In an environment with controlled  ambient temperature and moisture  and with minimal air flow the main  contribution to the skin s thermal variations can be considered to orig  inate from the blood perfusion  3 . Number of physiological factors  affect the proper blood perfusion in the peripheral body parts  from  which the lower limbs are at higher risk of complications due to primary  diseases such as diabetes mellitus. Lower limb blood perfusion  i.e.  the  delivery of oxygenated blood and nutrients to the tissues can be  permanently disturbed due to certain medical conditions  the most  important of which is peripheral arterial disease  PAD  caused by  atherosclerotic narrowing in the arterial tree. In the United States alone  there are over 12 million patients suffering from PAD  4 . Suitability of  thermal imaging in the measurement of peripheral lower limb perfusion  has been researched in numerous studies  especially with diabetes pa  tients  1 2 5 6   and efforts to conceptualize the complex vascular net  works entailing the blood flow within the lower limbs have been  implemented with models  such as the concept of angiosomes  i.e. seg  ments of tissue in which blood flow is covered by a single source artery   7 10 . The current clinical PAD diagnostic methods include physio   logical measurements  such as ankle brachial index  toe brachial index  transcutaneous oximetry  TcSPO2   toe systolic pressure and skin  perfusion pressure. All of these methods require patient contact and do  not offer spatial information apart from a single measurement point.  Novel imaging methods such as indigo carmine angiography  perfusion  imaging and magnetic resonance imaging expose the patient either to  ionizing radiation  are invasive  require contrast agents or have limited   Corresponding author. Tampereen yliopisto  Korkeakoulunkatu 3  33720  Tampere  Finland.  E mail addresses  tomppa.pakarinen tuni.fi  T. Pakarinen   niku.oksala pshp.fi  N. Oksala   antti.vehkaoja tuni.fi  A. Vehkaoja .   Contents lists available at ScienceDirect  Informatics in Medicine Unlocked  u   zkw  s yo kr o     1ow  o to 1m y2w m k o2ty   https   doi.org 10.1016 j.imu.2022.100940  Received 30 December 2021  Received in revised form 28 March 2022  Accepted 1 April 2022   

Informatics in Medicine Unlocked 30  2022  100940 2availability and the equipment is expensive. The substantial develop   ment of thermal imaging technology during the last decades offers  multiple potential advantages over traditional thermal measurement  methods and provides an interesting measurement modality for remote  observation of body processes  especially due to its high spatial resolution and increasing sensitivity to small thermal variations.  In recent years  several groups have also studied the potential ad  vantages in dynamic thermal imaging instead of the traditional steady  state measurements. Dynamic approaches include active skin cooling  and recovery response  11 12   power spectral analysis of temperature  Fig. 1.Three artificial baseline artefacts on linear data corrected with recoverable  non recoverable and offset methods  using linear interpolation.   Fig. 2.IRlab workflow diagram. The workflow is divided by RGB computation in 2 main phases  indicated with a bolded horizontal line.  T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 3oscillations  13 14   reconstruction of blood flow from thermal varia   tions  3   wavelet analysis of skin temperature variations  15   and  spatial and temporal variations of thermal profiles  16 . Number of  groups have also focused on thermal video processing methods  such as  thermal motion tracking  17 . Also  thermal image registration is  covered between thermal  and visible image registration  11 18 19   yet  only few papers consider solely thermal image registration in the  biomedical or medical field  16 20 21 . Other published computational methods for dynamic thermal analysis are spectral filtering methods  3   13 14   thermal oscillations  21   classification of vascular beds  16   and thermal modulation for active cooling  12 22 23 . However  anal  ysis for the latter is mainly based on individual thermal images or on  another sensor type rather than on thermal video or image sequences.  The computation methods are usually presented sufficiently and  Sagaidachnyi et al. share their blood perfusion converter tool as a free to  use software but unfortunately  as far as we know  there are no other  Fig. 3.IRlab user interface presenting labeled UI tool panels. The UI figure presents a test data set from the right  left side  and left  right side  lower limb. The  hotspots seen in the image are optional thermal registration markers  attached to the lower limbs with an insulating layer between the marker and the limb.  Fig. 4.Registration of ROI. Registration area is selected in subfigure a . The selection view is the same for uni  and bilateral cases  but in bilateral cases both sides   reference and target  are cropped successively. Subfigure b  presents the bilateral registration  s manual phase  where the reference image  1st ROI  is registered with  the mirrored target image  2nd ROI . Manual registration is performed for the reference images after the automatic bilateral video registration phase. T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 4published freeware nor open source programs or computational tools  available. Thus  each group must either rebuild or purchase the analysis  environment. The commercial software from the major thermal camera  manufacturer  s focus on thermal data acquisition and conventional  viewing and graphing tools  rather than in depth analysis. Additionally   the current methods typically consider single images or steady state measurements. Hence  thermal imaging software supporting dynamic  physical modulation tests has not been conducted.  IRlab aims to help researchers in medical thermal imaging by  providing open source tools with an easy to use user interface for dy  namic peripheral thermal video analysis  especially aimed for lower  limb perfusion analysis. IRlab combines multiple aforementioned  Fig. 5.RGB stack computation and registration success inspection.   Fig. 6.Example from the angiosome drawing tool for a bilateral case. The first ROI is delineated on the reference image  ROI 1   which is then projected to the  registered target image  ROI 2 . Both ROIs can be modified separately after initial delineation. The three hot spots in both images are thermal markers attached to the  lower limb to help image registration. T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 5methods under a single platform and further extends the analysis by  several experimental methods. The proposed software focuses on lower  limb analysis due to the nature and location of PAD manifestation and its  most severe complication  critical limb threatening ischemia  CLTI .  IRlab is free to use and offers the complete source code under the  General Public Licence  GPL  3.  2.Methods  IRlab is programmed completely with Matlab R2020a  v. 9.8   MathWorks Inc.  MA   24 . The user interface is developed using the  Matlab App designer environment. IRlab utilizes Matlab image pro  cessing and signal analysis toolboxes. Most relevant software properties  and computational methods in IRlab are presented below.  2.1. Data import  The latest version  v. 1.0  supports comma separated values  .csv   and Matlab  .mat  extension files for import. Import is performed by  reading either parsed.csv files or the user can import.mat structures with  required fields  i.e. structure consisting of each frame as 2D matrix as a  field named  frameN    where N is the frame index. All import data is expected to contain temperature values. The limited import alternatives  originate from the lack of standardization for thermal image and video  output files  thus each supplier has developed their own proprietary file  formats. To import thermal video data directly from device to IRlab  the  user must acquire manufacturer specific import files to be bundled with  the software. The direct import may also require other manufacturer  specific resources  which are often available only after purchase.  2.2. Temporal and spatial resampling and filtering  Typical modern thermal camera sampling rate ranges between 5 Hz  and 30 Hz and for high end high speed cameras up to 105 frames per  second  3   yet such high sampling rates are not often required. Thermal  variations of the skin are slow and for example the frequency power  spectral analysis and spectral filtering methods of human skin consider  frequencies between 0.005 and 2 Hz  13   for which microbolometer  cameras with noise equivalent temperature difference of 20 mK can  extract information from only lower than 0.15 Hz bands  due to low SNR  on higher frequency bands when considering the amplitudes of human  skin thermal variations. Additionally  98  of the spectral power lay  within the 0.001  0.15 Hz band  14 . Thus  Nyquist sampling rate for  thermal cameras with 20 mK NETD is about 0.3 Hz. In the test run  Fig. 7.Gamma  left  and subtraction maps between initial and end of recovery phases during cold provocation. Gamma indices over 2 units exceed the threshold for  significant difference. Subtraction map presents the absolute temperature differences.  Fig. 8.Curve fitting using Eqn 4 for each measured angiosome.  T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 6presented in this study  the initial camera sampling rate was reduced  from 9Hz to 3Hz by averaging the excess frames with IRlab  s frame  averaging tool  after verifying that no significant limb movement takes  place in this averaging period. Averaging decreases the required data registration time and increases temporal signal to noise ratio  SNR  with  theoretical maximum factor of    n   where n is the number of averaging  rounds  though the method is not effective in reducing the prominent 1 f  noise in microbolometer cameras  26 . To speed up the processing and  Fig. 9.Band pass filtered plots and power spectrums for unilateral plantar PA angiosome.   Fig. 10.Starting point right after the cold provocation. The right limb  reference  shows lower overall temperatures and less spatial thermal variability in com  parison to the left limb  target . The hotspots around the limbs are thermal markers to aid in image registration. T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 7analysis  and to increase spatial SNR  it is beneficial to lower the spatial  resolution from high resolution cameras by using a spatial median  filtering or averaging the neighborhood pixels. Median filtering is usu  ally sufficient when there are no small targets of interest  25 . This  method also requires that there are no significant temperature gradients  within the neighborhood scale and high resolution images are not  required for any other reason. Our initial testing concluded that  320x240 pixel resolution is sufficient to analyze both lower limbs  simultaneously  when confined properly within the imaging area.  2.3. Image registration  Object motion correction has an essential role in dynamic thermal  imaging  since involuntary movement and drifting cannot usually be  avoided. Physical motion prevention would require e.g. body part fix  ation  which is not reasonable for long periods of time or in dynamic  modulation tests. IRlab allows the user to perform unilateral image  registration for a single rectangular region of interest  ROI   intended to  contain a single body part. Alternatively  the user may perform bilateral  registration of two symmetrically positioned body parts  such as lower  limbs. In a unilateral case  the image registration is performed using a  single rectangular ROI over all frames against a chosen reference image   i.e. the first frame within the analysis period. The registration uses  mono  or multimodal intensity based image registration with a variable  number of iteration rounds  i.e.  the image resolution is changed itera  tively until the optimization process converges or the maximum number  of iteration rounds is reached. Multimodal option may be needed if the  imaged thermal profile changes considerably over the imaging period  e.  g.  during active cooling modulation. Automatic registration properties  may also be changed from rigid to affine. IRlab utilizes Matlab  s image  processing toolbox for intensity based image registration  24 .  For bilateral cases  first two rectangular ROIs are cropped from a  reference image  consisting of bilateral body parts  e.g.  left and right  lower limb and both ROIs are registered first independently against their  respective cropped reference frames. After the automatic registration  phase  the user performs manual rigid registration between the refer  ence side  e.g.  right limb  and the mirrored target side  left limb .  Translation and rotation vectors are saved from the manual registration  and used to operate the prior  automatically registered target video data   resulting in a bilaterally registered dataset. 2.4. Gamma index and subtraction maps  Gamma index is a robust method to measure local similarity between  two datasets. Instead of measuring pixel by pixel absolute temperature  differences  the gamma index also considers high gradient areas  where  small spatial shifts in data may produce a large error to the absolute  difference. The gamma index computation is performed for each data  point by minimizing the squared sum of the gamma components  i.e.  distance to agreement  DTA  and temperature difference  TD   relative  to their respective gamma criteria. Gamma indices are calculated as  presented in Eqn 1    rm  min   rrCrt    rr   1    where rr and rt refer to the reference and target spatial locations and  where    rrCrt                                                            rr rt 2  d2 r  Tr rr  Tt rr  2  T2 r   2   In Eqn 2   Tr rr  Tr rr  2 is the squared difference between target  and reference temperatures  and  dm and  Tm are the DTA and TD  criteria  respectively  27 . Gamma computation has been originally  developed for dosimetry evaluation in radiotherapy  thus the DTA and  percentage difference criteria cannot be directly used in thermal eval  uation. The user must define the criteria  and their value depends on the  characteristic temperature differences and temperature gradients for the  inspected object. Weighting too much of any of the components can lead  to exaggeration of the gamma indices at isotropic areas  too high DTA  weight  or at high gradient areas  too high TD weight . IRlab utilizes an  open source CalcGamma function for gamma indices computation  28 .  We suggest a possible advantage of gamma map over the temperature  difference alone  for its ability to weight temperature gradients  which  could be useful e.g. in hotspot detection and delineation.  Since using gamma indices outside of radiotherapy is unconven   tional  IRlab is using subtraction map computation as the default anal  ysis method. Subtraction maps are computed as in Eqn 3 by simply  taking the latter squared part from the Eqn 2  Tdiff Tr rr  Tt rr   3    Fig. 11.Angiosome ROIs superimposed on the reference and target limbs on the initial frames before the cold modulation. The angiosomes are labeled on the  reference limb. T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 82.5. Region of interest delineation and bilateral projection  ROI drawing tool utilizes polygonal freehand drawing functions for  interactive angiosome delineation. The polygon vertices are used to  compute binary masks for each delineated ROI. Additionally  the poly  gon centroids are computed and saved as the locations for neighborhood  determination e.g. in spectral filtered flow computation  see section  2.9 . If the bilateral option has been chosen  the reference ROI is  delineated in the reference side and projected to the mirrored target side   see section 2.3 . In case of imperfect registration or asymmetrical  anatomy  both ROIs may be modified interactively after initial drawing.  There is no limit for the total number of ROIs.  2.6. Thermo modulation analysis  Dynamic thermal modulation tool analyses thermal recovery  caused  by active cooling or possibly the effects of active heating of an  anatomical location. The analysis uses the median values  computed for  each ROI to fit an exponential function  presented in Eqn 4. T t  T0e  tE   A   1 e  tE     4    where T0 is the initial temperature after thermal provocation  A is a  constant and   is the thermal time constant. The exponential function fit  can be evaluated with goodness of fit  GOF  parameters and by the vi  sual shape of the recovery curve. Finally  time constant   Eqn 4 is solved  and saved to the respective ROI structure together with the GOF   parameters. We hypothesize that normal  unrestricted  and healthy  perfusion to a single artery sourced angiosome  29  follows during  thermal recovery  with a time constant proportional to the vasculari   zation and perfusion of the area. Perfusion in angiosomes covered with  several source arteries could possibly be modeled as the superposition of  the source arteries proportional contribution.  2.7. Artefact removal  IRlab includes an artefact removal tool  30  for computed 1D tem  perature curves  which can be used in three types of artefacts from the  extracted median curves for each ROI. The removal methods are  Fig. 12.Subtraction maps  top row  at the start and end of the cold provocation and gamma indices  bottom row  between the end of the recovery period and the  initial temperatures prior to the cold provocation. Visual inspection of both maps shows signs of reduced recovery flow within the DML angiosome  and partly in the  LPA and MPA angiosomes of the reference limb. T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 9manual  i.e. the user selects manually the artefact locations. For the  cases where data has a corrupted section  which is not recoverable  the  data is interpolated from selected starting point to the end point via  linear interpolation. For recoverable data  i.e.  baseline or low frequency  artefact  the user may choose either data offset value or high pass  component injection. Data offset method simply offsets the chosen re  gion by a chosen value. The component injection first extracts a high  pass filtered component from the chosen region  then interpolates the  section as in the non recoverable method interpolation  and finally su  perimposes the high pass filtered component to the interpolated region.  The used artefact removal methods are presented in Fig. 1. The  recoverable method preserves the high frequency signal features e.g.  in cases of non uniformity correction  NUC  baseline shifts. However  the  user should always consider if such baseline correction is required.  2.8. Spectral analysis  Spectral analysis operates the input ROI median values with a min  imum order infinite impulse response bandpass filter using 60 dB stop  band attenuation. To suppress the transient filter response artefact   1000 point data padding is added prior to the filtering and truncated  from the filtered signal. IRlab supports 0.005  0.02 Hz  0.02  0.05 Hz   0.05  0.15 Hz  0.15  0.4 Hz  and 0.4 2.0 Hz band filtering  which  correspond to endothelial  neurogenic  myogenic  respiratory  and  Fig. 13.Median temperature curves of each angiosome.   Fig. 14.Results from cold provocation test analysis. Column names refer to the angiosomes and row names to the test parameters  where T0 is the temperature prior  to the cold provocation  Tstart is the temperature after the provocation and Tend is the temperature at the end of the recovery.  Fig. 15.Goodnes of fit  GOF  evaluation results for the exponential function fit. The validity of the results in the cold provocation test analysis should be recon   sidered if the GOF parameters indicate a poor exponential fit. T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 10cardiac origins  respectively  3 13 . The reduction in each band power  has been previously connected to the change in perfusion from the  above mentioned sources  but useful information is mainly concentrated  within the 0.005  0.15 Hz range. With current thermal cameras  the  respiratory and cardiac band SNR remains too low for extracting any  useful information  3 . Thus  an additional bandpass filter with  0.001  0.2 Hz frequency range is suggested for NEDT values higher than 20 mK. Spectral analysis tool computes the power spectrum and the  band power for each ROI. The power spectrum analysis is mainly  intended for steady state measurements since FFT loses the temporal  frequency information  thus neglecting the time dependent dynamic  component e.g.  in thermal modulation test. In cases of non steady state  measurement  the user may additionally use the wavelet analysis tool   which computes the continuous wavelet transforms and scale to period  Fig. 16.Spectral bands  endothelial  neurogenic  myogenic  respiratory and cardiac  of the MPA angiosome for both reference  above  and target  below  limbs.  Note the respiratory  cardiac and major part of the myogenic bands cannot be used due to low SNR resulting from high camera NETD. T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 11conversions  using the Morlet wavelet as the default convolution kernel.  2.9. Spectral filtered temperature to blood flow reconstruction  Bloodflow SBF t reconstruction from thermal signal ST t is based on  the spectral filtering of the endothelial  neurogenic and myogenic fre  quency bands as described by Sagaidachnyi et al.  3 . The IRlab  implementation computes Fast Fourier Transform  FFT  to transform the  whole polygonal ROI area and computes the flow plots for center of mass  pixels along the image stack time dimension with a spatial average from  1 pixel radius neighborhood. The FFT of the convolution kernel is an  exponential amplitude   phase modulation function operating on ST f   i.  e. F ST t  CsBtB SBF f  exp  z                 f c    k   1 i    ST f C  5    where SBF f is F SBF t    k is the heat conductivity of the skin  c is the  specific heat capacity of the skin    is the skin density and z is the skin  thickness and f is the frequency. The convolution between ST t and the  kernel modulates the frequency specific amplitude absorption and phase  delay  resulting in an estimation of total blood flow. Eqn 6 represents the  amplitude modulation part from Eqn 5 exp  z                 f c    k    6   and describes the depth dependent absorption rates of different  thermal oscillation frequencies  and the Eqn 7 phase delay  exp  iz                 f c    k    7   which considers the transmission delay for these oscillations  3 . The  final time dependent blood flow is obtained via inverse Fourier trans   form  i.e. St t  F 1 SBF f  .  3.Results  3.1. Software workflow description  Workflow in IRlab can be divided roughly in two main phases  i.e.   preprocessing phase and analysis phase  which are separated by RGB  computation. RGB computation creates an RGB image stack  which is  used for determining the ROI areas and as visual reference to the orig  inal image data. The preprocessing phase consists of data import  pre  processing and image registration steps  after which the RGB stack is  computed. The analysis phase is initiated with ROI delineation from the  Fig. 17.Endothelial blood flow  0.02 Hz  level estimation curves from each angiosome  s median values. Blue curve presents the reference  right limb  limb  s  angiosomes and the red curve the target  s  left limb . The plots indicate relative decrease of flow within the reference DML angiosome and slight decrease in the LPA  and MPA angiosomes  in agreement with Fig. 12.  For interpretation of the references to color in this figure legend  the reader is referred to the Web version of  this article.  T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 12RGB images and followed by time and frequency based analysis steps.  The complete workflow is shown in Fig. 2.  After RGB computation is performed and if the user wishes to change  the input processing parameters  the RGB must be recomputed.  Recomputation of a given analysis after modifying preprocessing pa  rameters will replace any prior computation results for the step.  Otherwise  the results of previous instances are preserved until over  written. Final results are saved via.mat export.  3.2. Program description  IRlab is programmed completely with Matlab R2020a  v. 9.8   due  Matlab  s extensive usage within the scientific community and numerous  inbuilt toolboxes and functions  which support data visualization and  analytics. IRlab will be compatible with future Matlab versions since it  has been created in the App Designer platform instead of graphical user  interface development environment  GUIDE . The user interface  UI  is  presented in Fig. 3  The user interface is divided in numbered subsections  which also  indicate the workflow phase within the program. Section 1a  holds the  import data button and preprocessing panel i.e.  normalization to an  object  re sampling  and registration UI properties. Section 1b  contains  the timeline sliders for the thermal video. In the first workflow step  the  input data is imported via the import button  and the start and end  sliders are used for analysis start and end point search. The UI main  figure shows the video frame corresponding to the slider positions. Also   in section 1c   the program shows the camera frame rate and current  frame and time in seconds. After the start and end time points are  chosen  resampling may be used to reduce the analyzed frame rate with  or without averaging. Next  the image data can be registered using the   Auto register   button. The video registration has two options  which can  be toggled using the  Bilateral   checkbox located in UI group 1a . When  checked  the program performs a bilateral analysis workflow. Other   wise  the analysis is performed unilaterally. The registration views are presented in Fig. 4.  UI group 2a  in Fig. 3 contains RGB image and temperature colormap  computation. The user may compute the RGB images in the background  or display an RGB video during transformation for registration result  inspection. The UI presents the RGB as sped up video and temperature  curve for a chosen sample point as presented in Fig. 5. Registration can  be recomputed at any stage  if needed.  UI group 3a  contains the ROI angiosome drawing tools and 2  checkboxes for bilateral analysis. If none are chosen  the ROIs are drawn  for the reference i.e.  the first registered data set. Otherwise  the target  dataset is included in the analysis. The dual ROI checkbox dictates if the  delineated ROI from the reference image is projected to the mirrored  target image. If a  bilateral   option is chosen but  dual   ROI is not  no  data mirroring is performed and the user must draw all ROIs manually   see Fig. 6 .  Each ROI is named prior to the delineation and added to the 3d   listbox. Bilateral ROIs are labeled with  ref  and  targ   subscripts. ROIs  can be activated from the listbox  after which they are visualized in the  main UI figure window overlayed with the original image data. Sliders  in UI group 1b  may be used to inspect the ROI positioning throughout  the thermal video.  The subtraction and gamma analysis buttons in UI group 3a  can be  used to compute a subtraction image or a gamma map between start and  end frames of the analysis. Registered data is used automatically  when  the frame registration phase is performed prior to the subtraction and  gamma map computation. Otherwise  only the unregistered results are  saved. Fig. 7 shows the unregistered greyscale results from subtraction  and gamma computation.  UI group 4a  contains the thermal and spectral analysis tools. Anal  ysis is only performed to the ROIs selected from the UI group  s 3a   listbox.  Median  sd  max  min  button computes the respective param   eters  plots the results and saves them to a result structure. The thermal  analysis button performs the thermal modulation analysis  including  exponential function fitting  time constant determination and GOF   Fig. 18.Wavelet magnitude scalo grams for each angiosome.  T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 13parameter computation. Resulting curve fits are presented in a separate  figure  see Fig. 8 .  Bandpass filtering button computes the frequency band passed  components for endothelial  neurogenic  myogenic  respiratory and  cardiac bands together with ROI power spectrum as shown in Fig. 9.  The results are again presented in a set of separate figures and saved  to the results structure. Finally  the spectral flow button reconstructs the  ROI specific blood flow from the thermal data  see section 2 . The results  are saved to the results structure. UI group 5a  consist of a name field  and a save button. The save button will store the results to a structure as.  mat format for later processing and analysis.  3.3. Sample run  Sample run was performed using data from a cold provocation test  for a single individual  with no history of vascular diseases  on the  plantar side of the lower limbs. First  the data was imported to IRlab and  the frame rate was reduced to 3 Hz by averaging. The start of the cold  provocation period was scanned with the  start time   slider using the  default colormap and the  end time   slider was set to the last datapoint   see Fig. 10 . No other preprocessing was performed.  Next  a bilateral analysis workflow was chosen  and the dataset was  registered using rigid transformations with 20 iteration rounds and a  multimodal optimizer. Bilateral registration results were visually vali  dated using the RGB video display option  while computing the RGB  image stack. Next  5 angiosomes  Medial plantar  MPA   Lateral plantar  angiosome  LPA   Calcaneal branch  CB   Peroneal angiosome  PA  and  hallux  DML  were delineated from the RGB reference image. Angio   some ROIs were drawn on the reference images  from which they were  projected to the mirrored target image stack. Each ROI was also slightly  modified after initial drawing to match the relative positions and size on  both limbs  see Fig. 11 .  Subtraction and gamma maps were computed and saved for the  cropped image areas. Both maps are presented in Fig. 12.  Next  median  minimum  maximum and standard deviation values  were computed for each angiosome. The temperature recovery curves  are presented in Fig. 13.  Next  the thermal analysis was performed for the median angiosome  values  using the exponential function  Eqn 4  fit and the heating pa  rameters  i.e. goodness of fit and time constant  were evaluated  see  Fig. 14 and 15 .  Before any further analysis  median data was low pass filtered with  F0.15 Hz stopband and 60 dB stopband attenuation to neglect data  outside of the predefined bands  section 2.8 . Band powers were  computed for each angiosome within endothelial and neurogenic bands.  Example angiosome  MPA  bands and band power for both limbs are  presented in Fig. 16.  Additionally  bilateral thermal flow analysis was performed for each  angiosome. The flow analysis  Eqn 5  was performed to the median  angiosome temperatures and only for the endothelial frequency band in  this sample run. To preserve the lower frequencies due to temperature  modulation test  the data was filtered with an infinite impulse response  filter with a stopband frequency set to 0.02 Hz. The skin parameters  were set to k 0B33WE m K Cc 3780 JE kg K C  1057 kgEm3  and the effective skin thickness d 2mmBThe endothelial band blood  flow estimations are presented in Fig. 17.  Finally  a wavelet analysis on each ROI was computed using Morlet   wavelet as the convolution kernel. Scale to frequencies conversions  were saved for visual inspection. The resulting magnitude scale grams  are presented in Fig. 18.  4.Discussion  IRlab provides a variety of processing and analysis options for time  and frequency based dynamic thermal analysis. IRlab also offers a clear  workflow which can be combined with thermal modulation tests. Bilateral delineation of multiple ROIs allows perfusion area division  based on the angiosome concept  which has a variety of possibilities in  the modern lower limb peripheral artery disease diagnostics  7 10 . In  addition  novel computational methods such as blood flow reconstruc   tion from slow temperature variations may constitute a better estima   tion of the real peripheral perfusion  especially when combined with the  other thermal metrics. IRlab is developed principally for lower limb  thermal analysis  based on the angiosome concept  though there are no  limitations for its use e.g. for upper body peripherals. IRlab is an ongoing  open source project and is under constant development. This means that  the program  the methods used in the program and their validation has  several known and unknown limitations and require further testing and  research. For example  Sagaidachnyi et al. concluded that 98  of the  spectral power and thus the majority of the information in temperature  variations lay within endothelial  neurogenic and myogenic bands  and  that camera sensor  s NETD should be 20 mK at maximum to have suf  ficient signal to noise ratio within all three bands  3 . Unfortunately  our  test equipment  FLIR E8  has NETD of 60 mK  which is not sufficient to  extract information from frequencies above the neurogenic band  i.e.  cardiac  respiratory and myogenic band information is lost. Other lim  itations due to the test equipment performance relates to the power  spectral and wavelet analysis  which will be further tested in our future  research using high end thermal cameras  with 10 20 mK NETD  high  sampling rates and spatial resolution. Additionally  since dynamic  thermal video analysis in the medical field is not yet well established   thermal image registration requires optimization and is currently time  consuming  unrobust and may require thermal markers especially if the  target body part temperature overlaps with the background.  5.Conclusions  Dynamic thermal imaging is a promising method for peripheral  vascular diagnostics. Dynamic modulation and thermal video extends  the standard thermal imaging  which is based on individual images  thus  providing no information about time dependent hemodynamics. For  example  the connection between peripheral ischemia and small thermal  variations has been demonstrated in a number of previous research. To  the best of our knowledge  there are no freely accessible  open source  programs to perform dynamic thermal analysis and processing to eval  uate peripheral perfusion in the human body. In addition  such tools  supporting dynamic measurement setups  such as thermal modulation  tests do not exist. Computational methods implemented in IRlab could  provide a useful and easily accessible framework and individual  computational components for researchers within the field of medical  thermal imaging. Although there are known limitations  such as regis  tration and speed optimization and unknown limitations  IRlab is an  ongoing open source project and community needs and reported issues  are taken into account during further development. The proposed soft  ware allows the user to perform standard analysis and processing  methods  along with novel dynamic measures combined with thermal  modulation tests. IRlab is intended mainly for PAD  and more specif   ically in CLTI research  but the software may be used for other part  within the body. We emphasize that IRlab is intended only to be used as  a research tool under the GPL  and should not be used in clinical  practice.  Declaration of competing interest  The authors declare that they have no known competing financial  interests or personal relationships that could have appeared to influence  the work reported in this paper.  Acknowledgements  Authors have no competing interest to declare. This research was  funded by the Instrumentarium Science Foundation  Finland  as a T. Pakarinen et al.                                                                                                                                                                                                                              

Informatics in Medicine Unlocked 30  2022  100940 14personal grant for Tomppa Pakarinen  s doctoral research  and by State  Research Funding  VTR   Finland.  References   1 Subramaniam Bagavathiappan  Saravanan Thangavelu  Philip John  Jayakumar T   Raj Baldev  Rajamanickam Karunanithi  Panicker T  Korath M  Jagadeesan K.  Infrared thermal imaging for detection of peripheral vascular disorder. J Med Phys  2009 34 43  7. https   doi.org 10.4103 0971 6203.48720 .   2 Peregrina Barreto H  Morales Hern  andez L  Rangel Magdaleno J  Avina   Cervantes J  Ramirez Cortes J  Morales Caporal R. Quantitative estimation of  temperature variations in plantar angiosomes  a study case for diabetic foot.  Comput Math Methods Med 2014 585306. https   doi.org 10.1155 2014   585306 .   3 Sagaidachnyi A  Fomin A  Usanov D  Skripal A. Thermography based blood flow  imaging in human skin of the hands and feet  a spectral filtering approach. Feb  Physiol Meas 2017 38 2  272  88. https   doi.org 10.1088 1361 6579 aa4eaf .  Epub 2017 Jan 18. PMID  28099162.   4 Gerhard Herman M  et al. 2016 AHA ACC guideline on the management of  patients with lower extremity peripheral artery disease. Circulation 2017 135   e686  725.   5 Mori Taketoshi  Nagase Takashi  Takehara Kimie  Oe Makoto  Ohashi Yumiko   Amemiya Ayumi  Noguchi Hiroshi  Ueki Kohjiro  Kadowaki Takashi   Sanada Hiromi. Morphological pattern classification system for plantar  thermography of patients with diabetes. J.Diabetes.Sci. Technol. 2013 7 1102  12.  https   doi.org 10.1177 193229681300700502 .   6 Gatt A  Falzon O  Cassar K  Ellul C  Camilleri K  Gauci J  Mizzi S  Mizzi A   Sturgeon D  Cassandra  Camilleri L  Chockalingam N  Formosa C. Establishing  differences in thermographic patterns between the various complications in  diabetic foot disease. Int. J. Endocrinol. 2018 1  7. https   doi.org 10.1155 2018   9808295 . 2018.   7 Rother U  Lang W  Horch RE  Ludolph I  Meyer A  Gefeller O  Regus S. Pilot  assessment of the angiosome concept by intra operative fluorescence angiography  after tibial bypass surgery. Feb Eur J Vasc Endovasc Surg 2018 55 2  215  21.  https   doi.org 10.1016 j.ejvs.2017.11.024 . Epub 2018 Jan 3. PMID  29305093.   8 Seixas A  Ammer K  Carvalho R  Vilas Boas JP  Vardasca R  Mendes J. Skin  temperature in diabetic foot patients  a study focusing on the angiosome concept.  In  Tavares J  Natal Jorge R  editors. VipIMAGE 2017. ECCOMAS. Lecture notes in  computational vision and biomechanics  vol. 27. Cham  Springer  2018. https     doi.org 10.1007 978 3 319 68195 5 114 .   9 Huang TY  Huang TS  Wang YC  Huang PF  Yu HC  Yeh CH. Direct  revascularization with the angiosome concept for lower limb ischemia  a  systematic review and meta analysis. Aug Medicine  Baltim  2015 94 34  e1427.  https   doi.org 10.1097 MD.0000000000001427 . PMID  26313796  PMCID   PMC4602934.   10  Sumpio B  Forsythe R  Ziegler K  van Baal J  Lepantalo M  Hinchliffe R. Clinical  implications of the angiosome model in peripheral vascular disease. Sep J Vasc  Surg 2013 58 3  814  26. https   doi.org 10.1016 j.jvs.2013.06.056 . PMID   23972249.   11  Kaczmarek M  Nowakowski A. Active IR thermal imaging in medicine. J Nondestr  Eval 2016 35. https   doi.org 10.1007 s10921 016 0335 y .   12  Soliz P  et al. Detection of diabetic peripheral neuropathy using spatial temporal  analysis in infrared videos. In  50th asilomar conference on signals  systems and  computers  2016  2016. p. 263 7. https   doi.org 10.1109 ACSSC.2016.7869038 .   13  Geyer M  Yih Kuen J  Brienza D  Boninger M. Using wavelet analysis to  characterize the thermoregulatory mechanisms of sacral skin blood flow. J Rehabil  Res Dev 2004 41 797  806. https   doi.org 10.1682 JRRD.2003.10.0159 .  14  Sagaidachnyi A  Volkov I  Fomin A. In  Influence of temporal noise on the skin  blood flow measurements performed by cooled thermal imaging camera  limit  possibilities within each physiological frequency range   Proc. SPIE 9917  Saratov  Fall Meeting 2015  third International Symposium on Optics and Biophotonics and  Seventh Finnish Russian Photonics and Laser Symposium  PALS   99170N  2016.  https   doi.org 10.1117 12.2229476 . 21 April.   15  Zadeh G  Hamidreza J  Farshad N  Bijan R. In  The application of wavelet transform  in diagnosing and grading of varicocele in thermal images  the selected papers of  the first international conference on fundamental research in electrical  engineering  2019. https   doi.org 10.1007 978 981 10 8672 4 11 .   16  Chang K  Yoon S  Sheth N  Seidel M  Antalek M  Ahad J  Darlington T  Ikeda A   Kato GJ  Ackerman H  Gorbach AM  Rapid vs. Delayed infrared responses after  ischemia reveal recruitment of different vascular beds. Quant InfraRed Thermogr J  2015 12 2  173  83. https   doi.org 10.1080 17686733.2015.1046677 . Epub  2015 Jun 16. PMID  26435756  PMCID  PMC4589278.   17  Tze Yuan C  Cila H. Motion tracking in infrared imaging for quantitative medical  diagnostic applications. Infrared Phys Technol 2013 62. https   doi.org 10.1016   j.infrared.2013.10.009 .   18  Liu G  Liu Z  Liu S  et al. Registration of infrared and visible light image based on  visual saliency and scale invariant feature transform. J Image Video Proc 2018 45.  https   doi.org 10.1186 s13640 018 0283 9 .   19  Gonz  alez P  erez S  Perea Str om D  Arteaga Marrero N  Luque C  Sidrach Cardona I   Villa E  Ruiz Alzola J. Assessment of registration methods for thermal infrared and  visible images for diabetic foot monitoring. Sensors 2021 21 7  2264. https   doi.  org 10.3390 s21072264 .   20  Gorbach A  Ackerman H  Liu W  Meyer J  Littel P  Seamon C  Footman E  Chi A   Zorca S  Krajewski M  Cuttica M  Machado R  Cannon R  Kato G. Infrared imaging  of nitric oxide mediated blood flow in human sickle cell disease. Nov Microvasc  Res 2012 84 3  262  9. https   doi.org 10.1016 j.mvr.2012.06.011 . Epub 2012  Jul 8. PMID  22784510  PMCID  PMC3483464.   21  Gorbach AM  Wang H  Elster E. Thermal oscillations in rat kidneys  an infrared  imaging study. Philos. Trans. R. Soc. A Math. Phys. Eng. Sci. 2008 366 3633  47.   22  Bharara M  Viswanathan V  Cobb JE. Cold immersion recovery responses in the  diabetic foot with neuropathy. Oct Int Wound J 2008 5 4  562  9. https   doi.org   10.1111 j.1742 481X.2008.00454.x . pub 2008 Sep 1. PMID  18783470.   23  Fujiwara Y  Inukai T  Aso Y  Takemura Y. Thermographic measurement of skin  temperature recovery time of extremities in patients with type 2 diabetes mellitus.  2000 .   24  Matlab. Version 9.8  R2020b. Natick  Massachusetts  The MathWorks Inc  2020 .   25  Budzan S  Wylzgolik R. Remarks on noise removal in infrared images. Measurement  Automation Monitoring 2015 61 187  90.   26  Hanson C. In  Implications of 1 f noise in uncooled thermal imaging   Proc. SPIE  10624  Infrared Technology and Applications XLIV  106241C  2018. https   doi.  org 10.1117 12.2306334 .   27  Low D  Harms W  Mutic S  Purdy J. A technique for the quantitative evaluation of  dose distributions. Med Phys 1998 25 5  656  61. https   doi.org 10.1118   1.598248 . PMID  9608475.   28  Geurts M. CalcGamma  GitHub repository. Available at  https   github.  com mwgeurts gamma   2014. 5.8.2020.   29  Alexandrescu V  S oderstr  om M  Venermo M. Angiosome theory  fact or fiction   Scand J Surg 2012 101 2  125  31. https   doi.org 10.1177   145749691210100209 . PMID  22623446.   30  Pakarinen T  Pietil  a J  Nieminen H. Prediction of self perceived stress and arousal  based on electrodermal activity  . In  Conference proceedings  annual international  conference of the IEEE engineering in medicine and biology society. IEEE  engineering in medicine and biology society. Conference  2019. p. 2191  5. https     doi.org 10.1109 EMBC.2019.8857621 . 2019. T. Pakarinen et al.                                                                                                                                                                                                                              

